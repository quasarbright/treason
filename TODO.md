- [x] integrate expander into server
  - [x] add new core forms
  - [x] continue after error. see [notes](./notes.md#error-recovery)
  - [x] error -> diagnostic
- [ ] bug: find all references should also work on reference site, not just definition site
- [ ] check if client supports things before you call them, via client capabilities sent in init
- [ ] more services
  - [ ] unused var
  - [ ] autocomplete
  - [ ] rename symbol
  - [ ] syntax highlighting
  - [ ] macro/variable info on hover. like maybe the pattern?
  - [ ] definition vs use-site indicator?
  - [ ] macro vs variable indicator?
  - [ ] see expanded form of highlighted selection
  - [ ] disappeared use indication?
  - [ ] tokenizer so `foo-bar` is one "word"
- [ ] bug: goto definition and usages on macros won't work because neither are present in expanded code! need to record this stuff during expansion or something. see [notes](./notes.md#goto-definition-and-references-with-macros)
- [ ] figure out definition and use-site during expander pass? or at least record info to do that. might be best done after the ambient db stuff with hashes from node id to info.
- [ ] handle bad syntax in lsp operations
- [ ] handle eof in json-rpc message reader
- [ ] graceful error handling
- [ ] properly link the server executable so the command in the extension can just be treason-language-server and not a hard-coded path
- [ ] decouple server logic from json, or at least make convenient wrappers
- [ ] test after making server more testable
- [ ] shutdown
- [ ] figure out client capabilities once you start sending diagnostics. included in the initialize request
- [ ] explicitly define terminology like line, column, position, index, etc.
- [ ] cancellation? optional
- [ ] parse the file on update and store ast, don't want to parse on every operation
  - [ ] define a `find-enclosing-sexpr: loc? -> (or #f stx?)` which finds the enclosing sexpr. goto-definition and goto-references can just do a eq? check to compare identifiers with the given sexpr instead of checking for location. you could also cache parent references to make this even easier. NOTE this might not be possible with macros since they duplicate template spans
- [ ] do after syntax-spec support probably: let's say you're writing an if and so far you have `(if (...))` just the condition. you won't get IDE services bc the whole if fails to expand since the use-site doesn't match the pattern. for some macros, you actually should expand sub-expressions even if the use-site is malformed. can use grammar to inform whether to do this.
- [ ] incremental reactive thing. see [notes](./notes.md#incremental-reactive)
- [ ] how the hell can you do autocomplete inside of a macro use? you don't have binding info until after expansion, right? if the use ends up erroring because you're still typing it, how would you possibly have information about bindings available inside of that? either way, the expanded syntax can completely change as you're typing, especially if it's a big compiler macro. maybe you'll have scopes up to but not from inside of the use site that you can use, and it'll be better than nothing.
- [ ] make sure syntax error nodes don't affect transformers. should be fine in pattern-based, but may cause problems in procedural.
- [ ] pattern-bound variable references in template should count as references/definitions
- [ ] goto definition can have multiple answers if the reference ends up being duplicated and resolves multiple separate times
- [ ] think about format-identifier like auto-generated struct field accessors
- [x] abstraction for stx replacements. `(stx-rebuild syn (let ([,x^ ,rhs^]) ,body^))`
  - go element by element. for equal datum/structure vs origin, copy origin span. for unquoted forms, just directly inject without editing span.
- [x] stx patterns or stx matching
- [x] no parent, immutable, simplify tests. macro expansion will make parent weird
- [x] decouple server logic from read/write over wire
- [x] go to definition
- [x] consider decoupling LSP stuff from language stuff. For example, goto-definition returns a result in LSP format and takes in an LSP position, even though stx and spans are the internal types
- [x] when you do "get references", make sure `gd` on definition site fetches references. Currently, goto-definition on the binding site returns `#f`. Might need to make it return the binding site anyway.