- [ ] integrate expander into server
  - [ ] add new core forms
  - [ ] continue after error. see [notes](./notes.md#error-recovery)
  - [ ] error -> diagnostic
- [ ] handle eof in json-rpc message reader
- [ ] graceful error handling
- [ ] properly link the server executable so the command in the extension can just be treason-language-server and not a hard-coded path
- [ ] decouple server logic from json, or at least make convenient wrappers
- [ ] test after making server more testable
- [ ] shutdown
- [ ] figure out client capabilities once you start sending diagnostics. included in the initialize request
- [ ] explicitly define terminology like line, column, position, index, etc.
- [ ] cancellation? optional
- [ ] parse the file on update and store ast, don't want to parse on every operation
  - [ ] define a `find-enclosing-sexpr: loc? -> (or #f stx?)` which finds the enclosing sexpr. goto-definition and goto-references can just do a eq? check to compare identifiers with the given sexpr instead of checking for location. you could also cache parent references to make this even easier. NOTE this might not be possible with macros since they duplicate template spans
- [ ] do after syntax-spec support probably: let's say you're writing an if and so far you have `(if (...))` just the condition. you won't get IDE services bc the whole if fails to expand since the use-site doesn't match the pattern. for some macros, you actually should expand sub-expressions even if the use-site is malformed. can use grammar to inform whether to do this.
- [ ] incremental reactive thing. see [notes](./notes.md#incremental-reactive)
- [x] abstraction for stx replacements. `(stx-rebuild syn (let ([,x^ ,rhs^]) ,body^))`
  - go element by element. for equal datum/structure vs origin, copy origin span. for unquoted forms, just directly inject without editing span.
- [x] stx patterns or stx matching
- [x] no parent, immutable, simplify tests. macro expansion will make parent weird
- [x] decouple server logic from read/write over wire
- [x] go to definition
- [x] consider decoupling LSP stuff from language stuff. For example, goto-definition returns a result in LSP format and takes in an LSP position, even though stx and spans are the internal types
- [x] when you do "get references", make sure `gd` on definition site fetches references. Currently, goto-definition on the binding site returns `#f`. Might need to make it return the binding site anyway.